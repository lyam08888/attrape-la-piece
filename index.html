<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Pixel Adventure 2 - RPG Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="rpgInterface.css">
</head>
<body class="game-page">
    <!-- Conteneur de Jeu avec Interface RPG -->
    <div id="gameContainer">
        <canvas id="gameCanvas" tabindex="0"></canvas>
        <!-- L'interface RPG sera inject√©e ici par le gestionnaire -->
    </div>

    <script type="module">
        // Import des modules ES6
        import { GameEngine } from './engine.js';
        import { Player } from './player.js';
        import { TILE, generateLevel, ensureWorldColumns } from './world.js';
        import { Enemy } from './enemy.js';
        import { PNJ } from './PNJ.js';
        import { generatePNJ } from './generateurPNJ.js';
        import { ParticleSystem } from './fx.js';
        import { TimeSystem } from './timeSystem.js';
        import { TimeSystem as CalendarSystem } from './calendar.js';
        import { CHEST_TYPES } from './chestGenerator.js';
        import { DisasterManager } from './disasterManager.js';
        import { generateAnimal } from './generateurAnimaux.js';
        import { LightingSystem as AdvancedLighting } from './lighting.js';
        import { SURVIVAL_ITEMS } from './survivalItems.js';
        import { generateMonster } from './generateurMonstres.js';
        import { Enemy as BaseEnemy, Slime } from './enemy.js';
        import { integrateAdvancedSystems } from './advancedSystemsIntegration.js';
        import { convertAdvancedWorldToBasic, enrichBasicWorldWithAdvancedData, syncWorldChanges } from './worldIntegration.js';
        import { RPGInterfaceManager } from './rpgInterfaceManager.js';
        
        // Import des nouveaux syst√®mes
        import { AnimalManager, Animal } from './animalSystem.js';
        import { FoodSystem } from './foodSystem.js';
        import { ComplexWorldSystem } from './worldComplexSystem.js';
        import { integrateComplexWorld } from './gameIntegration.js';
        import { createEnvironmentPanel, createDisasterMenu, createCharacterPanel } from './uiPanels.js';
        
        import { Logger } from './logger.js';
        import { ChatSystem } from './chat.js';
        import { QuestSystem, updateQuestUI } from './questSystem.js';
        import { Inventory, updateInventoryUI } from './inventorySystem.js';
        import { PlayerStats, CombatSystem, BiomeSystem, updatePlayerStatsUI } from './combatSystem.js';
        import { WeatherSystem, LightingSystem } from './weatherSystem.js';
        import { Minimap, initializeMinimap, drawMinimapToElement } from './minimap.js';
        import { EnemySpawner } from './enemySpawner.js';
        import { SaveSystem, createSaveUI } from './saveSystem.js';

        window.updateQuestUI = updateQuestUI;
        window.gameModuleReady = true;

        // Configuration par d√©faut
        const defaultConfig = {
            "version": "2.0-RPG",
            "tileSize": 16,
            "zoom": 3,
            "worldWidth": 2048,
            "worldHeight": 1024,
            "generation": { "enemyCount": 10, "treeCount": 20 },
            "physics": {
                "gravity": 0.35,
                "jumpForce": 8,
                "playerSpeed": 3,
                "friction": 0.85,
                "airResistance": 0.98,
                "maxFallSpeed": 10,
                "groundAcceleration": 0.4,
                "airAcceleration": 0.2,
                "wallSlideSpeed": 1.5,
                "wallJumpForce": 6,
                "glideGravity": 0.1,
                "glideFallSpeed": 0.5
            },
            "player": {
                "width": 16,
                "height": 24,
                "hitbox": {
                    "offsetX": 2,
                    "offsetY": 4,
                    "width": 12,
                    "height": 20
                }
            },
            "chunkSize": 16,
            "renderDistance": 8,
            "particles": true,
            "weather": true,
            "lighting": true,
            "mobileMode": false
        };

        // Variables globales
        let game = null;
        let engine = null;
        let config = defaultConfig;

        // Fonction pour charger la configuration
        async function loadConfig() {
            try {
                const resp = await fetch('config.json');
                if (!resp.ok) throw new Error(`HTTP error! status: ${resp.status}`);
                const loadedConfig = await resp.json();
                config = { ...defaultConfig, ...loadedConfig };
                return config;
            } catch (e) {
                console.warn("Impossible de charger config.json. Utilisation de la configuration par d√©faut.", e);
                return defaultConfig;
            }
        }

        // Fonction pour redimensionner le canvas
        function resizeCanvas() {
            const canvas = document.getElementById('gameCanvas');
            if (!canvas) return;

            const container = canvas.parentElement;
            const rect = container.getBoundingClientRect();
            
            canvas.width = rect.width;
            canvas.height = rect.height;
            
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
        }

        // Fonction principale d'initialisation du jeu
        async function initializeGame(seed = null) {
            console.log("üéÆ Initialisation du jeu RPG...");
            
            try {
                // Charger la configuration
                config = await loadConfig();
                console.log("‚úÖ Configuration charg√©e");

                // Redimensionner le canvas
                resizeCanvas();
                
                // Cr√©er le moteur de jeu
                engine = new GameEngine(document.getElementById('gameCanvas'), config);
                
                // Initialiser l'interface RPG compl√®te
                console.log("üéÆ Initialisation de l'interface RPG...");
                const rpgInterface = new RPGInterfaceManager();
                window.rpgInterface = rpgInterface;
                
                // Cr√©er l'objet game
                game = {
                    config: config,
                    canvas: document.getElementById('gameCanvas'),
                    ctx: document.getElementById('gameCanvas').getContext('2d'),
                    rpgInterface: rpgInterface,
                    
                    // Syst√®mes de base
                    tileMap: [],
                    player: null,
                    camera: { x: 0, y: 0 },
                    mouse: { x: 0, y: 0, left: false, right: false },
                    
                    // Entit√©s
                    enemies: [],
                    pnjs: [],
                    animals: [],
                    collectibles: [],
                    projectiles: [],
                    particles: [],
                    chests: [],
                    
                    // Syst√®mes avanc√©s
                    particleSystem: null,
                    combatSystem: null,
                    biomeSystem: null,
                    weatherSystem: null,
                    lightingSystem: null,
                    questSystem: null,
                    inventory: null,
                    saveSystem: null,
                    
                    // √âtat du jeu
                    time: 0,
                    paused: false,
                    
                    // Fonctions utilitaires
                    createParticles: function(x, y, count, color) {
                        if (this.particleSystem) {
                            this.particleSystem.createParticles(x, y, count, color);
                        }
                    },
                    
                    updateUI: function() {
                        if (this.rpgInterface) {
                            this.rpgInterface.updateHUD();
                        }
                    }
                };
                
                window.game = game;
                
                // FIXED: G√©n√©rer le monde avec les bons param√®tres
                console.log("üåç G√©n√©ration du monde...");
                const worldWidthInTiles = Math.floor(config.worldWidth / config.tileSize);
                const worldHeightInTiles = Math.floor(config.worldHeight / config.tileSize);
                game.tileMap = generateLevel(worldWidthInTiles, worldHeightInTiles, seed);
                
                // Cr√©er le joueur
                console.log("üë§ Cr√©ation du joueur...");
                game.player = new Player(400, 300, config, null);
                
                // Int√©grer les syst√®mes avanc√©s
                try {
                    integrateAdvancedSystems(game);
                    console.log("‚úÖ Syst√®mes avanc√©s int√©gr√©s !");
                } catch (error) {
                    console.warn("‚ö†Ô∏è Erreur int√©gration syst√®mes avanc√©s:", error);
                }
                
                // Initialiser les syst√®mes RPG
                initializeRPGSystems();
                
                console.log("‚úÖ Jeu RPG initialis√© avec succ√®s !");
                return true;
                
            } catch (error) {
                console.error("‚ùå Erreur lors de l'initialisation du jeu:", error);
                throw error;
            }
        }

        // Fonction pour initialiser les syst√®mes RPG
        function initializeRPGSystems() {
            console.log("üéØ Initialisation des syst√®mes RPG...");
            
            try {
                // Syst√®me de qu√™tes
                game.questSystem = new QuestSystem();
                game.questSystem.addQuest({
                    id: 'welcome',
                    title: 'Bienvenue dans le monde RPG',
                    description: 'Explorez ce monde fantastique du Paradis √† l\'Enfer',
                    progress: 0,
                    maxProgress: 1,
                    type: 'tutorial',
                    active: true
                });
                
                // Syst√®me d'inventaire
                game.inventory = new Inventory();
                
                // Syst√®me de combat
                game.combatSystem = new CombatSystem();
                
                // Syst√®me de biomes
                game.biomeSystem = new BiomeSystem();
                
                // Syst√®me de particules
                game.particleSystem = new ParticleSystem();
                
                // Syst√®me de sauvegarde
                game.saveSystem = new SaveSystem();
                
                console.log("‚úÖ Syst√®mes RPG initialis√©s !");
                
            } catch (error) {
                console.warn("‚ö†Ô∏è Erreur lors de l'initialisation des syst√®mes RPG:", error);
            }
        }

        // Logique de jeu principale
        const gameLogic = {
            async init(assets = {}) {
                console.log("Initialisation de la logique de jeu...");
                
                // Le jeu est d√©j√† initialis√© par initializeGame()
                game.assets = assets;
                
                return true;
            },

            update(delta, keys, mouse) {
                if (!game || !game.player || game.paused) return;
                
                try {
                    // FIXED: Update mouse position in game object
                    if (mouse) {
                        game.mouse = mouse;
                    }
                    
                    // Mettre √† jour le joueur
                    game.player.update(keys, game, delta);
                    
                    // R√©g√©n√©ration des stats RPG
                    if (game.player.regenerateStats) {
                        game.player.regenerateStats(delta);
                    }
                    
                    // Mettre √† jour les syst√®mes
                    if (game.particleSystem) game.particleSystem.update();
                    if (game.combatSystem) game.combatSystem.update(delta);
                    if (game.biomeSystem) game.biomeSystem.update(game, delta);
                    if (game.weatherSystem) game.weatherSystem.update(game, delta);
                    if (game.questSystem) game.questSystem.update(delta);
                    
                    // Mettre √† jour la cam√©ra
                    updateCamera();
                    
                    // Mettre √† jour l'interface
                    game.updateUI();
                    
                    // Mettre √† jour le temps
                    game.time += delta;
                    
                } catch (error) {
                    console.error("Erreur dans la mise √† jour du jeu:", error);
                }
            },

            draw(ctx, assets, delta) {
                if (!game || !game.player) return;
                
                try {
                    // Effacer le canvas
                    ctx.clearRect(0, 0, game.canvas.width, game.canvas.height);
                    
                    // Dessiner le fond d√©grad√© (Paradis √† Enfer)
                    const gradient = ctx.createLinearGradient(0, 0, 0, game.canvas.height);
                    gradient.addColorStop(0, '#FFE4B5');    // Paradis
                    gradient.addColorStop(0.15, '#87CEEB'); // Ciel
                    gradient.addColorStop(0.3, '#32CD32');  // For√™ts
                    gradient.addColorStop(0.45, '#9370DB'); // Cristaux
                    gradient.addColorStop(0.6, '#DAA520');  // Plaines
                    gradient.addColorStop(0.75, '#8B4513'); // Terres sombres
                    gradient.addColorStop(0.9, '#8B0000');  // Enfer
                    gradient.addColorStop(1, '#000000');    // Abysse
                    
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, game.canvas.width, game.canvas.height);
                    
                    // Appliquer la transformation de cam√©ra
                    ctx.save();
                    ctx.translate(-game.camera.x, -game.camera.y);
                    
                    // Dessiner le monde
                    drawWorld(ctx);
                    
                    // Dessiner les entit√©s
                    drawEntities(ctx);
                    
                    // Dessiner le joueur
                    drawPlayer(ctx);
                    
                    // Dessiner les particules
                    if (game.particleSystem) {
                        game.particleSystem.draw(ctx);
                    }
                    
                    ctx.restore();
                    
                } catch (error) {
                    console.error("Erreur dans le rendu du jeu:", error);
                }
            },

            // FIXED: Add isPaused method
            isPaused() {
                return game ? game.paused : false;
            }
        };

        // Fonction de mise √† jour de la cam√©ra
        function updateCamera() {
            const { zoom, worldWidth, worldHeight } = config;
            const canvasWidth = game.canvas.width || 800;
            const canvasHeight = game.canvas.height || 600;

            let targetX = game.player.x + game.player.w / 2 - canvasWidth / 2 / zoom;
            let targetY = game.player.y + game.player.h / 2 - canvasHeight / 2 / zoom;

            const maxCameraX = Math.max(0, worldWidth - (canvasWidth / zoom));
            const maxCameraY = Math.max(0, worldHeight - (canvasHeight / zoom));

            game.camera.x = Math.max(0, Math.min(targetX, maxCameraX));
            game.camera.y = Math.max(0, Math.min(targetY, maxCameraY));
        }

        // Fonction de rendu du monde
        function drawWorld(ctx) {
            const { tileSize, zoom } = config;
            
            // Calculer la zone visible
            const startX = Math.floor(game.camera.x / tileSize) - 1;
            const endX = startX + Math.ceil(game.canvas.width / tileSize / zoom) + 2;
            const startY = Math.floor(game.camera.y / tileSize) - 1;
            const endY = startY + Math.ceil(game.canvas.height / tileSize / zoom) + 2;
            
            for (let y = Math.max(0, startY); y < Math.min(game.tileMap.length, endY); y++) {
                for (let x = Math.max(0, startX); x < Math.min(game.tileMap[0]?.length || 0, endX); x++) {
                    const tileType = game.tileMap[y]?.[x];
                    if (tileType > 0) {
                        drawTile(ctx, x, y, tileType);
                    }
                }
            }
        }

        // Fonction de rendu d'une tuile
        function drawTile(ctx, x, y, tileType) {
            const { tileSize } = config;
            
            // Couleurs selon le type de tuile
            const colors = {
                1: '#32CD32',  // Herbe
                2: '#8B4513',  // Terre
                3: '#696969',  // Pierre
                4: '#8B4513',  // Bois
                5: '#228B22',  // Feuilles
                6: '#2F2F2F',  // Charbon
                7: '#CD853F',  // Fer
                8: '#000000',  // Bedrock
                9: '#4169E1',  // Eau
                10: '#9370DB', // Cristal
                // Nouvelles tuiles RPG
                71: '#FFD700', // Pierre divine
                72: '#F0F8FF', // Terre b√©nie
                73: '#E6E6FA', // Cristal c√©leste
                101: '#8B0000', // Pierre infernale
                111: '#2F2F2F', // Pierre du vide
            };
            
            ctx.fillStyle = colors[tileType] || '#696969';
            ctx.fillRect(x * tileSize, y * tileSize, tileSize, tileSize);
        }

        // Fonction de rendu des entit√©s
        function drawEntities(ctx) {
            // Dessiner les PNJ
            game.pnjs.forEach(pnj => {
                ctx.fillStyle = '#FFD700';
                ctx.fillRect(pnj.x - 8, pnj.y - 8, 16, 16);
            });
            
            // Dessiner les ennemis
            game.enemies.forEach(enemy => {
                ctx.fillStyle = '#FF0000';
                ctx.fillRect(enemy.x - 8, enemy.y - 8, 16, 16);
            });
            
            // Dessiner les animaux
            game.animals.forEach(animal => {
                ctx.fillStyle = '#32CD32';
                ctx.fillRect(animal.x - 6, animal.y - 6, 12, 12);
            });
        }

        // Fonction de rendu du joueur
        function drawPlayer(ctx) {
            ctx.fillStyle = '#FF6B6B';
            ctx.fillRect(game.player.x, game.player.y, game.player.w, game.player.h);
            
            // Indicateur de joueur
            ctx.fillStyle = '#FFFFFF';
            ctx.font = '12px VT323';
            ctx.textAlign = 'center';
            ctx.fillText('VOUS', game.player.x + game.player.w/2, game.player.y - 5);
        }

        // Gestionnaire d'√©v√©nements clavier
        function setupKeyboardHandlers() {
            const keys = {};
            
            window.addEventListener('keydown', (e) => {
                keys[e.key.toLowerCase()] = true;
                
                // Raccourcis de l'interface RPG
                if (game.rpgInterface) {
                    switch (e.key.toLowerCase()) {
                        case 'i':
                            game.rpgInterface.toggleWindow('inventoryWindow');
                            break;
                        case 'c':
                            game.rpgInterface.toggleWindow('characterWindow');
                            break;
                        case 'q':
                            game.rpgInterface.toggleWindow('questWindow');
                            break;
                        case 'm':
                            game.rpgInterface.toggleWindow('mapWindow');
                            break;
                        case 'o':
                            game.rpgInterface.toggleWindow('craftingWindow');
                            break;
                        case 'j':
                            game.rpgInterface.toggleWindow('journalWindow');
                            break;
                        case 'escape':
                            game.rpgInterface.toggleWindow('settingsWindow');
                            break;
                    }
                }
            });
            
            window.addEventListener('keyup', (e) => {
                keys[e.key.toLowerCase()] = false;
            });
            
            return keys;
        }

        // Fonction principale de d√©marrage
        async function startGame() {
            console.log("üöÄ D√©marrage du jeu RPG...");
            
            try {
                // Initialiser le jeu
                await initializeGame();
                
                // Configurer les gestionnaires d'√©v√©nements
                const keys = setupKeyboardHandlers();
                
                // Redimensionnement automatique
                window.addEventListener('resize', resizeCanvas);
                
                // D√©marrer le moteur de jeu
                await engine.start(gameLogic);
                
                console.log("‚úÖ Jeu RPG d√©marr√© avec succ√®s !");
                
                // Notification de bienvenue
                if (game.rpgInterface) {
                    setTimeout(() => {
                        game.rpgInterface.showNotification(
                            'Bienvenue dans Super Pixel Adventure 2 - RPG Edition !',
                            'success',
                            5000
                        );
                    }, 1000);
                }
                
            } catch (error) {
                console.error("‚ùå Erreur lors du d√©marrage du jeu:", error);
                alert("Erreur lors du d√©marrage du jeu. Veuillez recharger la page.");
            }
        }

        // D√©marrage automatique quand la page est charg√©e
        document.addEventListener('DOMContentLoaded', () => {
            console.log("üìÑ DOM charg√©, d√©marrage du jeu...");
            startGame();
        });

        // Rendre les fonctions accessibles globalement
        window.game = game;
        window.initializeGame = initializeGame;
        window.startGame = startGame;
        
    </script>
</body>
</html>